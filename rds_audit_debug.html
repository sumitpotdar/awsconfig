<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDS Security Audit Dashboard - Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">üîç API Connection Debugger</h1>
            
            <!-- Configuration -->
            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Endpoint URL</label>
                    <input 
                        type="text" 
                        id="apiEndpoint" 
                        placeholder="https://abc123.execute-api.us-east-1.amazonaws.com/prod/scan"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <input 
                        type="password" 
                        id="apiKey" 
                        placeholder="Enter your API Key"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tag Key</label>
                        <input 
                            type="text" 
                            id="tagKey" 
                            value="app_id"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tag Value</label>
                        <input 
                            type="text" 
                            id="tagValue" 
                            value="APP001"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        />
                    </div>
                </div>
                
                <button 
                    id="testBtn" 
                    class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium"
                >
                    üöÄ Test API Connection
                </button>
            </div>

            <!-- Debug Output -->
            <div id="debugOutput" class="hidden">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">Debug Information</h2>
                
                <!-- Request Details -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-2">üì§ Request Details</h3>
                    <div class="space-y-2 text-sm">
                        <div><span class="font-medium">Method:</span> <span id="reqMethod" class="font-mono"></span></div>
                        <div><span class="font-medium">URL:</span> <span id="reqUrl" class="font-mono text-xs break-all"></span></div>
                        <div><span class="font-medium">Headers:</span></div>
                        <pre id="reqHeaders" class="bg-white p-2 rounded border text-xs overflow-x-auto"></pre>
                        <div><span class="font-medium">Body:</span></div>
                        <pre id="reqBody" class="bg-white p-2 rounded border text-xs overflow-x-auto"></pre>
                    </div>
                </div>

                <!-- Response Details -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-gray-700 mb-2">üì• Response Details</h3>
                    <div class="space-y-2 text-sm">
                        <div><span class="font-medium">Status:</span> <span id="resStatus" class="font-mono"></span></div>
                        <div><span class="font-medium">Status Text:</span> <span id="resStatusText" class="font-mono"></span></div>
                        <div><span class="font-medium">Headers:</span></div>
                        <pre id="resHeaders" class="bg-white p-2 rounded border text-xs overflow-x-auto"></pre>
                        <div><span class="font-medium">Body:</span></div>
                        <pre id="resBody" class="bg-white p-2 rounded border text-xs overflow-x-auto"></pre>
                    </div>
                </div>

                <!-- Error Details -->
                <div id="errorSection" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-red-700 mb-2">‚ùå Error Details</h3>
                    <pre id="errorDetails" class="text-sm text-red-800 whitespace-pre-wrap"></pre>
                </div>

                <!-- Success Details -->
                <div id="successSection" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-green-700 mb-2">‚úÖ Success!</h3>
                    <div class="text-sm text-green-800">
                        <div>API connection successful!</div>
                        <div id="instanceCount" class="font-medium mt-2"></div>
                    </div>
                </div>

                <!-- Troubleshooting Tips -->
                <div id="troubleshooting" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h3 class="font-semibold text-yellow-800 mb-2">üí° Troubleshooting Tips</h3>
                    <ul id="tips" class="text-sm text-yellow-800 space-y-1 list-disc list-inside"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('testBtn').addEventListener('click', async function() {
            const apiEndpoint = document.getElementById('apiEndpoint').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const tagKey = document.getElementById('tagKey').value.trim();
            const tagValue = document.getElementById('tagValue').value.trim();

            // Clear previous results
            document.getElementById('debugOutput').classList.remove('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('tips').innerHTML = '';

            // Validation
            if (!apiEndpoint) {
                alert('Please enter API Endpoint URL');
                return;
            }
            if (!apiKey) {
                alert('Please enter API Key');
                return;
            }

            // Prepare request
            const headers = {
                'Content-Type': 'application/json',
                'X-API-Key': apiKey
            };
            
            const body = {
                tagKey: tagKey,
                tagValue: tagValue
            };

            // Display request details
            document.getElementById('reqMethod').textContent = 'POST';
            document.getElementById('reqUrl').textContent = apiEndpoint;
            document.getElementById('reqHeaders').textContent = JSON.stringify(headers, null, 2);
            document.getElementById('reqBody').textContent = JSON.stringify(body, null, 2);

            // Make request
            try {
                console.log('üöÄ Sending request to:', apiEndpoint);
                console.log('üì¶ Request body:', body);
                console.log('üîë API Key:', apiKey.substring(0, 10) + '...');

                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                console.log('üì• Response status:', response.status);
                console.log('üì• Response headers:', [...response.headers.entries()]);

                // Display response details
                document.getElementById('resStatus').textContent = response.status;
                document.getElementById('resStatusText').textContent = response.statusText;
                
                // Get response headers
                const resHeadersObj = {};
                response.headers.forEach((value, key) => {
                    resHeadersObj[key] = value;
                });
                document.getElementById('resHeaders').textContent = JSON.stringify(resHeadersObj, null, 2);

                // Get response body
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                    document.getElementById('resBody').textContent = JSON.stringify(responseData, null, 2);
                } catch (e) {
                    document.getElementById('resBody').textContent = responseText;
                    responseData = null;
                }

                // Analyze response
                if (response.ok) {
                    // Success
                    document.getElementById('successSection').classList.remove('hidden');
                    if (responseData && responseData.instances) {
                        document.getElementById('instanceCount').textContent = 
                            `Found ${responseData.instances.length} RDS instance(s)`;
                    }
                    addTip('‚úÖ API connection successful!', 'success');
                } else {
                    // Error response
                    document.getElementById('errorSection').classList.remove('hidden');
                    document.getElementById('errorDetails').textContent = 
                        `HTTP ${response.status}: ${response.statusText}\n\n` +
                        (responseText || 'No response body');

                    // Provide specific troubleshooting
                    if (response.status === 403) {
                        addTip('‚ùå 403 Forbidden - Invalid API Key or missing API Key header');
                        addTip('Check: Is your API Key correct?');
                        addTip('Check: Did you deploy your API after enabling CORS?');
                        addTip('Check: Is API Key required in the method settings?');
                    } else if (response.status === 404) {
                        addTip('‚ùå 404 Not Found - Check your API endpoint URL');
                        addTip('Format: https://API_ID.execute-api.REGION.amazonaws.com/STAGE/scan');
                    } else if (response.status === 500) {
                        addTip('‚ùå 500 Internal Server Error - Lambda function error');
                        addTip('Check CloudWatch Logs for Lambda function errors');
                    } else if (response.status === 502) {
                        addTip('‚ùå 502 Bad Gateway - Lambda timeout or malformed response');
                    } else if (response.status === 429) {
                        addTip('‚ùå 429 Too Many Requests - Rate limit exceeded');
                    }
                }

                // Check CORS headers
                if (!resHeadersObj['access-control-allow-origin']) {
                    addTip('‚ö†Ô∏è Missing CORS header: Access-Control-Allow-Origin');
                    addTip('Enable CORS in API Gateway and redeploy');
                }

            } catch (error) {
                // Network or CORS error
                console.error('‚ùå Request failed:', error);
                
                document.getElementById('errorSection').classList.remove('hidden');
                document.getElementById('errorDetails').textContent = 
                    `Error: ${error.message}\n\n` +
                    `Type: ${error.name}\n\n` +
                    `Stack: ${error.stack}`;

                // Troubleshooting for network errors
                if (error.message.includes('CORS')) {
                    addTip('‚ùå CORS Error - Your API is blocking browser requests');
                    addTip('Fix: Enable CORS in API Gateway console');
                    addTip('1. Go to API Gateway ‚Üí Your API ‚Üí /scan resource');
                    addTip('2. Actions ‚Üí Enable CORS');
                    addTip('3. Make sure X-API-Key is in allowed headers');
                    addTip('4. Actions ‚Üí Deploy API ‚Üí prod stage');
                } else if (error.message.includes('Failed to fetch')) {
                    addTip('‚ùå Network Error - Cannot connect to API');
                    addTip('Check: Is the API endpoint URL correct?');
                    addTip('Check: Is your API private? (only accessible from VPC)');
                    addTip('Check: Are you behind a firewall/proxy?');
                    addTip('Check: Is the API deployed to the correct stage?');
                } else {
                    addTip('‚ùå Unexpected error occurred');
                    addTip('Check browser console (F12) for more details');
                }
            }
        });

        function addTip(message, type = 'warning') {
            const li = document.createElement('li');
            li.textContent = message;
            if (type === 'success') {
                li.className = 'text-green-800';
            }
            document.getElementById('tips').appendChild(li);
        }

        // Show example on load
        window.addEventListener('load', function() {
            const example = document.createElement('div');
            example.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4';
            example.innerHTML = `
                <h3 class="font-semibold text-blue-800 mb-2">üìã Example Configuration</h3>
                <div class="text-sm text-blue-800 space-y-1 font-mono">
                    <div>Endpoint: https://abc123def.execute-api.us-east-1.amazonaws.com/prod/scan</div>
                    <div>API Key: Your-API-Key-From-AWS-Console</div>
                    <div>Tag Key: app_id</div>
                    <div>Tag Value: APP001</div>
                </div>
            `;
            document.querySelector('.bg-white').appendChild(example);
        });
    </script>
</body>
</html>